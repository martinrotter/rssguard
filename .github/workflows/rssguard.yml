---
name: rssguard

on:
  push:
    branches: ["*"]
    tags: ["*"]

env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

jobs:
  check-build-script:
    name: check-build-script
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Check script syntax
        run: bash -n ./resources/scripts/github-actions/build-linux-mac.sh

      - name: Show shellcheck version
        run: shellcheck --version

      - name: Run shellcheck
        run: shellcheck --color=always ./resources/scripts/github-actions/build-linux-mac.sh

  source-tarball:
    name: create-source-tarball
    runs-on: ubuntu-latest
    needs: check-build-script

    steps:
      - name: Checkout source code with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Determine version and tarball name
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="devbuild5"
          fi

          SHORT_SHA="$(git rev-parse --short HEAD)"
          TAR_NAME="rssguard-${VERSION}-${SHORT_SHA}-src.tar.gz"

          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV

      - name: Create full source tarball
        run: |
          TMPDIR="$(mktemp -d)/rssguard-${VERSION}"
          export TMPDIR

          # Main repository
          git archive --format=tar HEAD | tar -x -C "${TMPDIR}"

          # Submodules (recursive)
          git submodule foreach --recursive '
            mkdir -p "${TMPDIR}/${path}" &&
            git archive --format=tar HEAD | tar -x -C "${TMPDIR}/${path}"
          '

          # Final compressed tarball
          tar -czf "${TAR_NAME}" -C "${TMPDIR}/.." "$(basename "${TMPDIR}")"

      - name: Upload source tarball
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: ${{ env.TAR_NAME }}

  build-rssguard:
    needs:
      - check-build-script
      - source-tarball
    name: "${{ matrix.os }}; qt5 = ${{ matrix.use_qt5 }}"
    runs-on: "${{ matrix.os }}"
    container: ${{ matrix.cont }}
    strategy:
      matrix:
        os: [windows-2022, ubuntu-24.04, macos-15]
        use_qt5: ["ON", "OFF"]
        include:
          - os: windows-2022
            script_name: .\resources\scripts\github-actions\build-windows.ps1
            cont: null
          - os: ubuntu-24.04
            script_name: ./resources/scripts/github-actions/build-linux-mac.sh
            cont: ghcr.io/pkgforge-dev/archlinux:latest
          - os: macos-15
            script_name: ./resources/scripts/github-actions/build-linux-mac.sh
            cont: null
        exclude:
          - os: macos-15
            use_qt5: "ON"
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Prepare Linux environment
        run: chmod +x ./resources/scripts/github-actions/prepare-linux.sh && ./resources/scripts/github-actions/prepare-linux.sh
        if: matrix.os == 'ubuntu-24.04'

      - name: Checkout source code submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Prepare environment and compile application
        run: ${{ matrix.script_name }} "${{ matrix.os }}" "${{ matrix.use_qt5 }}"
        env:
          FEEDLY_CLIENT_ID: ${{ secrets.FEEDLY_CLIENT_ID }}
          FEEDLY_CLIENT_SECRET: ${{ secrets.FEEDLY_CLIENT_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: RSS_Guard-${{ runner.os }}-Qt${{ matrix.use_qt5 == 'ON' && '5' || '6' }}
          path: |
            ./rssguard-build/rssguard-*win*.exe
            ./rssguard-build/rssguard-*win*.7z
            ./rssguard-build/rssguard-*mac64.dmg
            ./rssguard-build/rssguard-*linux64.AppImage

  dist-binaries:
    name: distribute-binaries
    needs:
      - build-rssguard
      - source-tarball
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Download binaries and source tarball
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Release development binaries
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifacts: artifacts/*/*
          name: Development builds (5.x line)
          omitBodyDuringUpdate: true
          prerelease: true
          removeArtifacts: true
          tag: devbuild5

      - name: Update "devbuild5" tag
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: richardsimko/update-tag@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: devbuild5

      - name: Release stable binaries
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          artifactErrorsFailBuild: true
          artifacts: artifacts/*/*
          draft: true
